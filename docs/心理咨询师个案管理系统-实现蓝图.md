# 心理咨询师个案管理系统（个人版）实现蓝图（AI Coding 版）

## 1. 技术选型（落地版）

- 前端：Vue 3 + Vite + TypeScript + Naive UI
- 状态管理：Pinia
- 日历：FullCalendar（timeGridWeek + interaction）
- 本地数据库：SQLite（建议 better-sqlite3）
- ORM/查询层：Kysely（类型友好、轻量）
- 重复规则：rrule
- Markdown：`@bytemd/vue-next`（或先用 textarea + preview）
- 文件打包：JSZip
- ICS：ical-generator（或手写 RFC5545）
- 本地 HTTP 服务：Node `http`（提供 `/calendar.ics`）
- App 容器：Capacitor（后续接入）

---

## 2. 推荐目录结构

```txt
src/
  app/
    router.ts
    store.ts
    App.vue
  db/
    index.ts
    schema.ts
    migrations/
      001_init.sql
  features/
    calendar/
      CalendarPage.vue
      calendar.store.ts
      calendar.api.ts
      components/
        AppointmentModal.vue
    clients/
      ClientsPage.vue
      ClientDetailPage.vue
      clients.store.ts
    files/
      ClientFilesPanel.vue
      MarkdownEditor.vue
    settings/
      SettingsPage.vue
    stats/
      StatsPage.vue
  services/
    calendarService.ts
    clientService.ts
    fileService.ts
    icsService.ts
    exportService.ts
  server/
    ics-server.ts
  shared/
    types.ts
    enums.ts
    time.ts
    paths.ts
    validators.ts
```

---

## 3. 核心类型定义（TypeScript）

```ts
export type ClientStatus = 'Potential' | 'Active' | 'Paused' | 'Closed' | 'Referred'
export type AppointmentStatus = 'Scheduled' | 'Completed' | 'Canceled'
export type FileCategory = 'SessionNote' | 'Supervision' | 'Assessment'

export interface Client {
  id: string
  name: string
  status: ClientStatus
  tagsJson: string
  notes?: string | null
  createdAt: number
  updatedAt: number
}

export interface Appointment {
  id: string
  clientId: string
  startAt: number
  endAt: number
  status: AppointmentStatus
  recurringSeriesId?: string | null
  originalInstanceAt?: number | null
  note?: string | null
  createdAt: number
  updatedAt: number
}

export interface WeekEvent {
  id: string
  source: 'single' | 'recurring'
  clientId: string
  clientName: string
  startAt: number
  endAt: number
  status: AppointmentStatus
  recurringSeriesId?: string
  originalInstanceAt?: number
}
```

---

## 4. 数据库表与迁移（示例 SQL）

```sql
create table if not exists clients (
  id text primary key,
  name text not null,
  status text not null,
  tags_json text not null default '[]',
  notes text,
  created_at integer not null,
  updated_at integer not null
);
create index if not exists idx_clients_status on clients(status);
create index if not exists idx_clients_name on clients(name);

create table if not exists appointments (
  id text primary key,
  client_id text not null,
  start_at integer not null,
  end_at integer not null,
  status text not null,
  recurring_series_id text,
  original_instance_at integer,
  note text,
  created_at integer not null,
  updated_at integer not null,
  foreign key (client_id) references clients(id)
);
create index if not exists idx_appt_start_at on appointments(start_at);
create index if not exists idx_appt_client_start on appointments(client_id, start_at);
create index if not exists idx_appt_status on appointments(status);
```

---

## 5. Service 接口签名（建议直接实现）

## 5.1 calendarService.ts

```ts
export interface CreateAppointmentInput {
  clientId: string
  startAt: number
  durationMin?: number
  note?: string
  recurring?: {
    rrule: string
    dtstart: number
    durationMin: number
    untilAt?: number
    count?: number
  }
}

export async function createAppointment(input: CreateAppointmentInput): Promise<string>
export async function moveAppointment(
  apptId: string,
  newStartAt: number,
  newEndAt: number,
  scope: 'this' | 'series'
): Promise<void>

export async function updateAppointmentStatus(
  apptId: string,
  status: 'Scheduled' | 'Completed' | 'Canceled'
): Promise<void>

export async function getWeekSchedule(weekStart: number, weekEnd: number): Promise<WeekEvent[]>
```

## 5.2 clientService.ts

```ts
export async function listClients(query: {
  keyword?: string
  status?: ClientStatus
  tag?: string
  sortBy?: 'next' | 'last' | 'created'
}): Promise<Array<{
  client: Client
  completedCount: number
  totalHours: number
  lastCompletedAt: number | null
  nextScheduledAt: number | null
}>>

export async function getClientStats(clientId: string): Promise<{
  completedCount: number
  totalHours: number
  lastCompletedAt: number | null
  nextScheduledAt: number | null
}>
```

## 5.3 fileService.ts

```ts
export async function createSessionNoteFromAppointment(apptId: string): Promise<string>
export async function createMarkdownFile(
  clientId: string,
  category: 'SessionNote' | 'Supervision',
  title: string,
  content: string,
  relatedAppointmentId?: string
): Promise<string>

export async function uploadFile(
  clientId: string,
  category: 'Assessment',
  file: { name: string; bytes: Uint8Array }
): Promise<string>
```

## 5.4 icsService.ts

```ts
export async function generateIcs(): Promise<string>
export async function getIcsUrl(): Promise<{ localhost: string; lan?: string }>
export async function startIcsServer(bind: '127.0.0.1' | '0.0.0.0', port: number): Promise<void>
```

## 5.5 exportService.ts

```ts
export async function exportAll(): Promise<{ zipPath: string; manifestPath: string }>
```

---

## 6. 核心流程实现要点

## 6.1 完成预约触发自动记录

1. `updateAppointmentStatus(apptId, 'Completed')`
2. 读取 appointment + client
3. 检查 files 表是否已存在 `related_appointment_id = apptId`
4. 无则写入：`clients/<clientId>/sessions/YYYY-MM-DD HH-mm.md`
5. 插入 files 记录（`category=SessionNote`）

## 6.2 周数据加载（含重复）

1. 拉取单次 appointments（区间内）
2. 拉取 recurring_series（与周区间有交集）
3. `rrule.between(weekStart, weekEnd)` 展开实例
4. 应用 recurring_exceptions（改期/取消）
5. 合并并映射给 FullCalendar

## 6.3 统计口径统一

- `completedCount = count(status='Completed')`
- `totalHours = completedCount`
- `lastCompletedAt = max(start_at where completed)`
- `nextScheduledAt = min(start_at where scheduled and > now)`

---

## 7. FullCalendar + Naive UI 组合示例

## 7.1 周日历容器

- 顶部用 `n-space + n-button + n-select`（周切换、新建预约、筛选）
- 中间渲染 FullCalendar timeGridWeek
- 右侧（可选）用 `n-drawer` 展示预约详情

## 7.2 交互映射

- `select`（拖选空白）→ 打开 `AppointmentModal`
- `eventDrop` / `eventResize` → 调 `moveAppointment`
- `eventClick` → 状态切换/编辑/删除

---

## 8. ICS 服务设计

- 默认配置：`bind=127.0.0.1, port=17777`
- 开启局域网时切换：`bind=0.0.0.0`
- 路由：`GET /calendar.ics`
- 返回头：`Content-Type: text/calendar; charset=utf-8`
- 设置页展示：
  - `http://127.0.0.1:17777/calendar.ics`
  - `http://<LAN_IP>:17777/calendar.ics`
- UI 显示风险提示：局域网可见日程标题

---

## 9. 导出 zip 结构

```txt
export-2026-02-15.zip
  db.sqlite
  files/
    clients/<clientId>/sessions/*.md
    clients/<clientId>/supervision/*.md
    clients/<clientId>/assessment/*
  manifest.json
```

`manifest.json` 建议字段：

```json
{
  "version": 1,
  "exportedAt": 1739600000000,
  "appVersion": "0.1.0",
  "db": { "name": "db.sqlite", "sha256": "..." },
  "files": { "count": 123, "sha256": "..." }
}
```

---

## 10. 测试清单（最小可行）

- 单元测试：
  - 周区间重复展开 + exception 合并
  - `Completed -> 自动生成咨询记录` 幂等
  - 个案统计 SQL 正确性
- 集成测试：
  - 创建预约 → 完成 → 文件生成 + files 表记录
  - 改期/取消后 ICS 内容变化
- 手工验收：
  - 非整点创建、跨周拖拽、重复预约“仅本次/整个系列”

---

## 11. 先做什么（给 AI 的执行顺序）

1. 建库迁移 + Repository。
2. 打通“单次预约 + 完成自动记录 + 个案统计”。
3. 接入 FullCalendar 拖拽改期。
4. 再加重复规则与 exceptions。
5. 最后做 ICS 与导出。

